<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASTER MEDS PRO - V7.4</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Lucide React -->
    <script>
        // Lucide React needs a 'react' global, but React UMD provides 'React'
        window.react = window.React;
    </script>
    <script src="https://unpkg.com/lucide-react"></script>
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes pulse-soft { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.05); opacity: 0.8; } }
        .animate-pulse-soft { animation: pulse-soft 2s infinite ease-in-out; }
    </style>
</head>
<body class="bg-[#F5F5F5] text-[#212121] font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const {
          Activity, Droplets, Syringe, Plus, X, Sparkles,
          FileText, Pill, AlertCircle, ShoppingCart,
          Moon, Sun, RotateCcw, Camera, Volume2,
          Loader2, UserPlus, Settings, ShieldCheck,
          Smile, Megaphone, ChevronDown, Check,
          CalendarDays, HeartPulse, Stethoscope, Thermometer,
          MessageCircle, Send, Download, BarChart3, Trophy, Lock, Key,
          Leaf, Apple, Utensils, Zap, BedDouble, Clock, Mic, FolderOpen,
          Share2, FileJson, AlertTriangle, Coffee, Sunrise, Sunset, ToggleLeft, ToggleRight,
          Phone, Eye, CloudRain, Wind, ThermometerSun, Mail, Save
        } = LucideReact;

        /**
         * MASTER MEDS PRO - V7.4 (FULL REWIRE)
         * - Feature: Dynamic Diet Tab (Toggleable)
         * - Feature: Editable Emergency Contact
         * - Feature: WhatsApp Clinical Sharing
         * - Feature: JSON Data Backup
         */

        // --- ASSETS & CONSTANTS ---
        const VIVID_THEME = {
          mint: "bg-[#E0F2F1] border-[#B2DFDB] text-[#004D40]",
          teal: "bg-[#26A69A] border-[#00695C] text-[#FFFFFF]",
          panda: "bg-[#FFFFFF] border-[#E0E0E0] text-[#212121]",
          yellow: "bg-[#FFF9C4] border-[#FFF176] text-[#F57F17]",
          blue: "bg-[#E1F5FE] border-[#B3E5FC] text-[#01579B]",
          red: "bg-[#FFEBEE] border-[#FFCDD2] text-[#B71C1C]",
          black: "bg-[#000000] border-[#333333] text-[#FFFFFF]",
          green: "bg-[#E8F5E9] border-[#A5D6A7] text-[#1B5E20]",
          purple: "bg-[#F3E5F5] border-[#E1BEE7] text-[#4A148C]"
        };

        const LIFESTYLE_TAGS = [
          { label: "Healthy Food", icon: Apple, color: "bg-green-100 text-green-700" },
          { label: "Fast Food", icon: Utensils, color: "bg-orange-100 text-orange-700" },
          { label: "High Sugar", icon: Sparkles, color: "bg-pink-100 text-pink-700" },
          { label: "Exercise", icon: Zap, color: "bg-blue-100 text-blue-700" },
          { label: "Good Sleep", icon: BedDouble, color: "bg-indigo-100 text-indigo-700" },
          { label: "Stress", icon: Activity, color: "bg-red-100 text-red-700" }
        ];

        const QUADRANTS = ['UL', 'UR', 'LL', 'LR'];
        const DAYS_OF_WEEK = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        // --- HELPERS ---
        const safeJsonParse = (str) => {
          try {
            // Remove markdown code blocks if present
            const cleanStr = str.replace(/```json\n?|\n?```/g, "").trim();
            return JSON.parse(cleanStr);
          } catch (e) {
            console.error("JSON Parse Error:", e, str);
            return null;
          }
        };

        // --- COMPONENTS ---

        const DashboardCard = ({ children, colorClass, title, icon: Icon, badge }) => (
          <div className={`p-6 md:p-8 rounded-[2.5rem] md:rounded-[3rem] border-2 border-black/10 shadow-[8px_8px_0px_rgba(0,0,0,0.05)] ${colorClass} mb-8 overflow-visible`}>
            <div className="flex justify-between items-center mb-6 overflow-visible">
              <div className="flex items-center gap-4 w-full">
                <div className="w-20 h-20 p-3 rounded-[1.5rem] bg-white shadow-md flex items-center justify-center overflow-visible shrink-0">
                  {Icon && <Icon size={36} className="text-black" />}
                </div>
                <div className="min-w-0 flex-1">
                  <h3 className="font-black text-xl md:text-3xl uppercase tracking-tight leading-tight truncate">{String(title || "")}</h3>
                  {badge && <span className="text-xs font-black px-3 py-1 bg-[#212121] text-white rounded-full mt-2 inline-block animate-pulse-soft">{String(badge || "")}</span>}
                </div>
              </div>
            </div>
            {children}
          </div>
        );

        // --- MAIN APP ---

        function App() {
          // --- STATE ---
          const [activeTab, setActiveTab] = useState('home');
          const [loading, setLoading] = useState(false);
          const [apiKeys, setApiKeys] = useState({ gemini: '' });
          const [pharmacy, setPharmacy] = useState({ name: '', phone: '', email: '' });
          const [emergencyContact, setEmergencyContact] = useState('');
          const [now, setNow] = useState(new Date());

          const fileInputRef = useRef(null);
          const chatEndRef = useRef(null);

          const [isListening, setIsListening] = useState(false);
          const [stats, setStats] = useState({ streak: 12, level: 3, xp: 2450, wellness: 88 });

          const [meds, setMeds] = useState([
            { id: 1, n: "Cozaar", d: "100mg", block: 'am', status: 'pending', time: '08:00', schedule: DAYS_OF_WEEK, count: 12 },
            { id: 2, n: "Vitamin D", d: "1000IU", block: 'am', status: 'pending', time: '09:00', schedule: DAYS_OF_WEEK, count: 28 },
            { id: 3, n: "Lyrica", d: "100mg", block: 'pm', status: 'pending', time: '20:00', schedule: DAYS_OF_WEEK, count: 5 },
            { id: 4, n: "Magnesium", d: "500mg", block: 'pm', status: 'pending', time: '21:00', schedule: DAYS_OF_WEEK, count: 15 },
            { id: 5, n: "Humira", d: "40mg", block: 'cycle', status: 'pending', time: 'Every 14 Days', schedule: ['Fri'], count: 2 },
            { id: 6, n: "Methotrexate", d: "Injection", block: 'cycle', status: 'pending', time: 'Weekly', schedule: ['Sat'], count: 4 }
          ]);

          const [vault, setVault] = useState([]);
          const [diary, setDiary] = useState([]);
          const [diaryInput, setDiaryInput] = useState("");
          const [selectedTags, setSelectedTags] = useState([]);

          const [lastInjection, setLastInjection] = useState({ site: 'LL', date: new Date().toISOString() });
          const [humiraCycle, setHumiraCycle] = useState({ anchorDate: "2026-01-23", cycleDays: 14 });

          const [safetyAnalysis, setSafetyAnalysis] = useState(null);
          const [showSafetyModal, setShowSafetyModal] = useState(false);
          const [dietPlan, setDietPlan] = useState(null);
          const [showDietModule, setShowDietModule] = useState(true);
          const [flareForecast, setFlareForecast] = useState(null);
          const [showInjectionPrep, setShowInjectionPrep] = useState(false);
          const [selectedInjectionSite, setSelectedInjectionSite] = useState(null);

          const [chatHistory, setChatHistory] = useState([{ role: 'model', text: "Hello! I'm your Medical Assistant. I can track your meds, analyze your diet, and help with interactions!" }]);
          const [chatInput, setChatInput] = useState("");

          // --- COMPUTED ---
          const morningMeds = useMemo(() => meds.filter(m => m.block === 'am'), [meds]);
          const eveningMeds = useMemo(() => meds.filter(m => m.block === 'pm'), [meds]);
          const cycleMeds = useMemo(() => meds.filter(m => m.block === 'cycle'), [meds]);

          const remainingHumiraDays = useMemo(() => {
            const anchor = new Date(humiraCycle.anchorDate);
            const diffTime = Math.abs(now - anchor);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return humiraCycle.cycleDays - (diffDays % humiraCycle.cycleDays);
          }, [humiraCycle, now]);

          const hasPending = meds.some(m => m.status === 'pending');
          const shouldShout = hasPending && (now.getHours() < 12 || now.getHours() > 18);

          // --- PERSISTENCE ---
          useEffect(() => {
            const saved = localStorage.getItem('master_meds_v7_4_final');
            if (saved) {
              const data = JSON.parse(saved);
              if (data.meds) setMeds(data.meds);
              if (data.stats) setStats(data.stats);
              if (data.vault) setVault(data.vault);
              if (data.diary) setDiary(data.diary);
              if (data.apiKeys) setApiKeys(data.apiKeys);
              if (data.pharmacy) setPharmacy(data.pharmacy);
              if (data.humiraCycle) setHumiraCycle(data.humiraCycle);
              if (data.lastInjection) setLastInjection(data.lastInjection);
              if (data.emergencyContact) setEmergencyContact(data.emergencyContact);
              if (data.dietPlan) setDietPlan(data.dietPlan);
              if (typeof data.showDietModule === 'boolean') setShowDietModule(data.showDietModule);
            }
            const ticker = setInterval(() => setNow(new Date()), 60000);
            return () => clearInterval(ticker);
          }, []);

          useEffect(() => {
            localStorage.setItem('master_meds_v7_4_final', JSON.stringify({
              meds, stats, vault, diary, apiKeys, humiraCycle, lastInjection, emergencyContact, dietPlan, pharmacy, showDietModule
            }));
          }, [meds, stats, vault, diary, apiKeys, humiraCycle, lastInjection, emergencyContact, dietPlan, pharmacy, showDietModule]);

          useEffect(() => {
            chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
          }, [chatHistory, activeTab]);

          // --- HELPERS ---
          const updateXP = (amount) => {
            setStats(prev => {
              const newXP = prev.xp + amount;
              return { ...prev, xp: newXP, level: Math.floor(newXP / 1000) + 1, wellness: Math.min(100, prev.wellness + 5) };
            });
          };

          const handleMedToggle = (id, action) => {
            setMeds(prev => prev.map(m => {
              if (m.id === id) {
                if (action === 'take' && m.status !== 'taken') {
                  updateXP(50);
                  return { ...m, status: 'taken', count: Math.max(0, m.count - 1) };
                }
                return { ...m, status: action === 'take' ? 'taken' : 'skipped' };
              }
              return m;
            }));
          };

          const handleOrderRefill = (med) => {
            if (!pharmacy.phone) {
                setActiveTab('settings');
                return setTimeout(() => alert("Please configure your Pharmacy WhatsApp number in the Admin tab."), 100);
            }
            const cleanPhone = pharmacy.phone.replace(/[^0-9]/g, '');
            const text = `Hi ${pharmacy.name || 'Pharmacy'}, I would like to order a refill for:\n\nüíä *${med.n}* (${med.d})\n\nPlease let me know when it is ready.`;
            window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(text)}`, '_blank');
          };

          const handleShareReport = () => {
            const text = `*MY CLINICAL REPORT*\n\n*Wellness Score:* ${stats.wellness}%\n*Adherence Level:* ${stats.level}\n\n*Latest Analysis:*\n${safetyAnalysis?.summary || "No recent analysis."}\n\n*Current Flare Risk:* ${flareForecast?.risk || "Unknown"}`;
            if(navigator.share) {
               navigator.share({ title: 'My Health Report', text: text }).catch(console.error);
            } else {
               window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            }
          };

          const handleExportData = () => {
             const dataStr = JSON.stringify({ meds, stats, vault, diary, pharmacy }, null, 2);
             const blob = new Blob([dataStr], { type: "application/json" });
             const url = URL.createObjectURL(blob);
             const link = document.createElement("a");
             link.href = url;
             link.download = `master_meds_backup_${new Date().toISOString().split('T')[0]}.json`;
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
          };

          const handleVoiceInput = (setter) => {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return alert("Voice input not supported in this browser.");
            const recognition = new SpeechRecognition();
            recognition.onstart = () => setIsListening(true);
            recognition.onend = () => setIsListening(false);
            recognition.onresult = (event) => {
               const transcript = event.results[0][0].transcript;
               setter(prev => (prev ? prev + " " : "") + transcript);
            };
            recognition.start();
          };

          // --- API LOGIC ---
          const fetchWithRetry = async (url, options) => {
            const res = await fetch(url, options);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
          };

          const runClinicalAnalysis = async () => {
            if (!apiKeys.gemini) return alert("API Key Missing in Admin tab");
            setLoading(true);
            try {
                const medHistory = meds.filter(m => m.status === 'taken').map(m => m.n).join(', ');
                const recentDiary = diary.slice(0, 10).map(d => `${d.time}: ${d.text}`).join('\n');
                const prompt = `Act as a Senior Rheumatologist. Analyze: Meds: ${medHistory}. Diary: ${recentDiary}. Task: Pattern/Trigger analysis. Return JSON: {"interactions": [], "correlations": [], "summary": ""}`;
                const data = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKeys.gemini}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                });
                setSafetyAnalysis(safeJsonParse(data.candidates[0].content.parts[0].text));
                setShowSafetyModal(true);
                updateXP(100);
            } catch (e) { alert("Analysis failed."); } finally { setLoading(false); }
          };

          const generateFlareForecast = async () => {
            if (!apiKeys.gemini || !selectedTags.length) return;
            try {
              const prompt = `Health Helper. Tags: ${selectedTags.join(', ')}. Predict Flare Risk (Low/Medium/High) and 1 tip. JSON: {"risk": "", "tip": ""}`;
              const data = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKeys.gemini}`, {
                  method: 'POST', headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
              });
              setFlareForecast(safeJsonParse(data.candidates[0].content.parts[0].text));
            } catch (e) { console.error(e); }
          };

          useEffect(() => { if (selectedTags.length > 0) generateFlareForecast(); }, [selectedTags]);

          const generateDietPlan = async () => {
            if (!apiKeys.gemini) return alert("API Key Missing in Admin tab");
            setLoading(true);
            try {
                const prompt = `1-day Clinical Meal Plan for meds: [${meds.map(m=>m.n).join(',')}]. JSON: {"preferredFoods": [], "meals": [], "hydrationGoal": ""}`;
                const data = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKeys.gemini}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                });
                setDietPlan(safeJsonParse(data.candidates[0].content.parts[0].text));
                updateXP(50);
            } catch (e) { alert("Meal plan failed."); } finally { setLoading(false); }
          };

          const handlePillScan = async (e) => {
            const file = e.target.files[0];
            if (!file || !apiKeys.gemini) return;
            setLoading(true);
            const reader = new FileReader();
            reader.onloadend = async () => {
               const base64 = reader.result.split(',')[1];
               try {
                 const prompt = `Identify med from image. JSON: {"name": "", "dosage": "", "schedule": []}`;
                 const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKeys.gemini}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64 } }] }], generationConfig: { responseMimeType: "application/json" } })
                 });
                 const result = safeJsonParse(res.candidates[0].content.parts[0].text);
                 setVault(prev => [{ id: Date.now(), name: result.name, date: new Date().toLocaleDateString(), image: reader.result }, ...prev]);
                 setMeds(prev => [...prev, { id: Date.now(), n: result.name, d: result.dosage, block: 'am', status: 'pending', count: 30, schedule: result.schedule || DAYS_OF_WEEK }]);
                 updateXP(100);
               } catch (err) { alert("Scan failed"); } finally { setLoading(false); }
            };
            reader.readAsDataURL(file);
          };

          return (
            <div className="pb-40">
              {shouldShout && <div className="fixed inset-0 z-[50] pointer-events-none border-[12px] border-red-500/30 animate-pulse"></div>}

              <header className="pt-8 pb-6 px-6 bg-white border-b-8 border-teal-50 sticky top-0 z-[100] flex justify-between items-center shadow-sm">
                 <div className="flex items-center gap-4">
                    <div className="w-16 h-16 rounded-2xl bg-white border-4 border-teal-100 p-1 flex items-center justify-center">
                       <HeartPulse size={40} className="text-teal-600" />
                    </div>
                    <div>
                       <h1 className="text-3xl font-black text-[#212121] leading-none tracking-tighter">MASTER<br/><span className="text-teal-600">MEDS PRO</span></h1>
                       <p className="text-[10px] font-bold text-teal-300 uppercase mt-1 tracking-widest">v7.4 Rewired</p>
                    </div>
                 </div>
                 <div className="flex flex-col items-end">
                    <div className="flex items-center gap-2 bg-teal-50 px-3 py-1 rounded-full border border-teal-100">
                       <Trophy size={14} className="text-yellow-500"/>
                       <span className="font-black text-teal-800 text-xs">LVL {stats.level}</span>
                    </div>
                    <div className="w-24 h-2 bg-gray-200 rounded-full mt-2 overflow-hidden">
                       <div className="h-full bg-teal-500 transition-all duration-1000" style={{ width: `${stats.wellness}%` }}></div>
                    </div>
                 </div>
              </header>

              {loading && (
                <div className="fixed inset-0 bg-white/90 backdrop-blur-xl z-[999] flex flex-col items-center justify-center">
                    <Loader2 size={64} className="text-teal-600 animate-spin" />
                    <p className="font-black text-xl uppercase tracking-widest text-teal-600 animate-pulse mt-4">Consulting AI...</p>
                </div>
              )}

              {showSafetyModal && safetyAnalysis && (
                <div className="fixed inset-0 z-[900] flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm">
                    <div className="bg-white w-full max-w-lg rounded-[2.5rem] p-8 shadow-2xl overflow-y-auto max-h-[80vh]">
                       <h2 className="text-2xl font-black uppercase mb-4 flex items-center gap-2"><Stethoscope className="text-blue-500"/> Doctor's Analysis</h2>
                       <div className="bg-blue-50 p-4 rounded-2xl mb-4 border border-blue-100 font-bold text-blue-900 text-sm">{safetyAnalysis.summary}</div>
                       <button onClick={() => setShowSafetyModal(false)} className="w-full py-4 bg-teal-600 text-white font-black rounded-2xl uppercase">Close</button>
                    </div>
                </div>
              )}

              {showInjectionPrep && (
                 <div className="fixed inset-0 z-[900] flex items-center justify-center p-6 bg-teal-900/90 backdrop-blur-sm">
                    <div className="bg-white w-full max-w-lg rounded-[2.5rem] p-8 shadow-2xl text-center">
                       <Syringe size={48} className="text-teal-600 mx-auto mb-4" />
                       <h2 className="text-2xl font-black uppercase mb-2">Nurse Prep: {selectedInjectionSite}</h2>
                       <div className="space-y-3 text-left my-6">
                          <label className="flex items-center gap-3 p-4 bg-gray-50 rounded-2xl border border-gray-100"><input type="checkbox" className="w-6 h-6" /><span className="font-bold text-sm">Room Temp</span></label>
                          <label className="flex items-center gap-3 p-4 bg-gray-50 rounded-2xl border border-gray-100"><input type="checkbox" className="w-6 h-6" /><span className="font-bold text-sm">Clean Site</span></label>
                       </div>
                       <div className="flex gap-4">
                          <button onClick={() => setShowInjectionPrep(false)} className="flex-1 py-4 bg-gray-200 font-black rounded-2xl">Cancel</button>
                          <button onClick={() => { setLastInjection({site:selectedInjectionSite, date:new Date().toISOString()}); setShowInjectionPrep(false); updateXP(75); }} className="flex-1 py-4 bg-teal-600 text-white font-black rounded-2xl">Log</button>
                       </div>
                    </div>
                 </div>
              )}

              <main className="px-6 mt-8">
                 {activeTab === 'home' && (
                    <>
                       {flareForecast && (
                         <div className="mb-8 p-6 rounded-[2.5rem] border-2 bg-blue-50 border-blue-100 flex items-center gap-6">
                            <div className="w-16 h-16 rounded-2xl bg-white flex items-center justify-center text-2xl">{flareForecast.risk === 'High' ? '‚õàÔ∏è' : 'üå§Ô∏è'}</div>
                            <div>
                               <h3 className="text-sm font-black uppercase opacity-50 tracking-widest">Flare Forecast</h3>
                               <h2 className="text-2xl font-black text-blue-700">{flareForecast.risk} Risk</h2>
                               <p className="text-xs font-bold opacity-70">{flareForecast.tip}</p>
                            </div>
                         </div>
                       )}

                       {cycleMeds.length > 0 && (
                          <div className="mb-8 p-6 rounded-[2.5rem] bg-white border-2 border-teal-100 shadow-[8px_8px_0px_#e0f2f1]">
                             <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-3"><Syringe size={24} className="text-teal-600"/><h3 className="font-black uppercase tracking-tight">Biologics</h3></div>
                                <span className="text-xs font-black text-teal-600">{remainingHumiraDays} DAYS LEFT</span>
                             </div>
                             <div className="h-4 w-full bg-teal-50 rounded-full border border-teal-100 overflow-hidden mb-6"><div className="h-full bg-teal-500" style={{ width: `${((14 - remainingHumiraDays) / 14) * 100}%` }}></div></div>
                             {cycleMeds.map(med => (
                                <div key={med.id} className="flex items-center justify-between p-4 mb-3 rounded-2xl bg-teal-50 border-2 border-teal-200">
                                   <div className="font-black">{med.n}</div>
                                   <button onClick={() => handleMedToggle(med.id, 'take')} className="w-10 h-10 bg-teal-500 text-white rounded-xl flex items-center justify-center"><Check/></button>
                                </div>
                             ))}
                          </div>
                       )}

                       <DashboardCard colorClass={VIVID_THEME.yellow} title="Morning Meds" icon={Sun}>
                          {morningMeds.map(med => (
                             <div key={med.id} className={`flex items-center justify-between p-4 mb-3 rounded-[2rem] bg-white border-2 border-black/5 ${med.status !== 'pending' ? 'opacity-40' : ''}`}>
                                <div><h4 className="font-black">{med.n}</h4><p className="text-[10px] uppercase font-bold text-gray-400">{med.d} ‚Ä¢ {med.time}</p></div>
                                <div className="flex gap-2">
                                   <button onClick={() => handleOrderRefill(med)} className="w-10 h-10 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center"><ShoppingCart size={18}/></button>
                                   <button onClick={() => handleMedToggle(med.id, 'take')} className="w-10 h-10 bg-green-500 text-white rounded-xl flex items-center justify-center"><Check/></button>
                                </div>
                             </div>
                          ))}
                       </DashboardCard>

                       <DashboardCard colorClass={VIVID_THEME.teal} title="Injection Site" icon={Syringe}>
                          <div className="grid grid-cols-2 gap-4">
                             {QUADRANTS.map(q => <button key={q} onClick={() => { setSelectedInjectionSite(q); setShowInjectionPrep(true); }} className={`p-4 rounded-[1.5rem] font-black text-xl ${lastInjection.site === q ? 'bg-white text-teal-900 border-4 border-teal-100' : 'bg-teal-900/20 text-teal-100/50'}`}>{q}</button>)}
                          </div>
                       </DashboardCard>

                       <DashboardCard colorClass={VIVID_THEME.panda} title="Diary" icon={FileText}>
                          <div className="flex flex-wrap gap-2 mb-4">
                             {LIFESTYLE_TAGS.map((tag, i) => (
                                <button key={i} onClick={() => setSelectedTags(prev => prev.includes(tag.label) ? prev.filter(t => t !== tag.label) : [...prev, tag.label])} className={`flex items-center gap-1 px-3 py-2 rounded-xl text-[10px] font-black ${selectedTags.includes(tag.label) ? tag.color : 'bg-gray-100 text-gray-400'}`}><tag.icon size={12}/> {tag.label}</button>
                             ))}
                          </div>
                          <div className="relative mb-4">
                             <input value={diaryInput} onChange={e => setDiaryInput(e.target.value)} placeholder="How do you feel?" className="w-full p-4 rounded-2xl border-2 font-bold outline-none" />
                             <button onClick={() => handleVoiceInput(setDiaryInput)} className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"><Mic size={20}/></button>
                          </div>
                          <button onClick={() => { if(!diaryInput) return; setDiary(prev => [{id:Date.now(), text:diaryInput, tags:selectedTags, time:new Date().toLocaleTimeString()}, ...prev]); setDiaryInput(''); updateXP(20); }} className="w-full py-4 bg-[#26A69A] text-white rounded-[2rem] font-black uppercase">Log</button>
                       </DashboardCard>
                    </>
                 )}

                 {activeTab === 'diet' && (
                    <DashboardCard colorClass={VIVID_THEME.green} title="Diet" icon={Leaf}>
                       {!dietPlan ? <button onClick={generateDietPlan} className="w-full py-4 bg-white text-green-700 font-black rounded-xl border border-green-100">Generate AI Plan</button> :
                        dietPlan.meals.map((m,i)=>(<div key={i} className="bg-white/60 p-4 rounded-2xl mb-2"><h4 className="font-black text-green-900">{m.name}</h4><p className="text-xs text-green-700">{m.desc}</p></div>))}
                    </DashboardCard>
                 )}

                 {activeTab === 'stats' && (
                    <DashboardCard colorClass={VIVID_THEME.blue} title="Clinical" icon={Stethoscope}>
                       <button onClick={runClinicalAnalysis} className="w-full py-4 bg-white text-blue-900 font-black rounded-xl mb-4">Run AI Analysis</button>
                       <button onClick={handleShareReport} className="w-full py-4 bg-green-500 text-white font-black rounded-xl">Share to WhatsApp</button>
                    </DashboardCard>
                 )}

                 {activeTab === 'chat' && (
                    <div className="h-[60vh] flex flex-col">
                       <div className="flex-1 overflow-y-auto space-y-4 mb-4">
                          {chatHistory.map((m,i)=>(<div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}><div className={`p-4 rounded-2xl max-w-[85%] font-bold text-sm ${m.role==='user'?'bg-teal-600 text-white':'bg-white border-2 border-gray-100'}`}>{m.text}</div></div>))}
                          <div ref={chatEndRef} />
                       </div>
                       <div className="flex gap-2 bg-white p-2 rounded-full border-2 border-gray-100">
                          <input value={chatInput} onChange={e=>setChatInput(e.target.value)} placeholder="Ask..." className="flex-1 p-3 bg-transparent font-bold outline-none" />
                          <button onClick={()=>{ if(!chatInput) return; setChatHistory(p=>[...p,{role:'user',text:chatInput}]); setChatInput(''); }} className="p-3 bg-teal-600 text-white rounded-full"><Send/></button>
                       </div>
                    </div>
                 )}

                 {activeTab === 'vault' && (
                    <DashboardCard colorClass={VIVID_THEME.mint} title="Vault" icon={FolderOpen}>
                       <div className="grid grid-cols-2 gap-4">
                          {vault.map(v=>(<div key={v.id} className="bg-white p-2 rounded-xl border-2"><img src={v.image} className="w-full h-20 object-cover rounded-lg mb-1"/><h4 className="font-black text-[10px] truncate">{v.name}</h4></div>))}
                          <div onClick={()=>fileInputRef.current.click()} className="bg-teal-100/50 p-2 rounded-xl border-2 border-dashed border-teal-200 flex flex-col items-center justify-center min-h-[100px] cursor-pointer"><Camera className="text-teal-400"/><span className="text-[10px] font-black text-teal-600">SCAN</span></div>
                       </div>
                    </DashboardCard>
                 )}

                 {activeTab === 'settings' && (
                    <DashboardCard colorClass={VIVID_THEME.black} title="Admin" icon={Lock}>
                       <label className="text-[10px] font-black text-gray-500 uppercase ml-2">API Key</label>
                       <input type="password" value={apiKeys.gemini} onChange={e=>setApiKeys({...apiKeys, gemini:e.target.value})} className="w-full p-4 bg-[#333] rounded-2xl text-white font-mono text-xs mt-1 mb-4" />
                       <input value={pharmacy.phone} onChange={e=>setPharmacy({...pharmacy, phone:e.target.value})} placeholder="WhatsApp Number" className="w-full p-4 bg-[#333] rounded-2xl text-white text-xs mb-4" />
                       <button onClick={handleExportData} className="w-full py-4 bg-[#444] text-white font-black rounded-2xl uppercase text-xs mb-4">Export Backup</button>
                       <button onClick={()=>{ if(confirm("Reset?")) localStorage.clear(); window.location.reload(); }} className="w-full py-4 bg-red-900 text-white font-black rounded-2xl uppercase text-xs">Factory Reset</button>
                    </DashboardCard>
                 )}
              </main>

              <input type="file" ref={fileInputRef} hidden accept="image/*" onChange={handlePillScan}/>

              <nav className="fixed bottom-0 left-0 right-0 bg-white border-t-4 border-teal-50 px-6 py-4 pb-8 flex justify-between items-center z-[800] shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
                 <button onClick={()=>setActiveTab('home')} className={activeTab==='home'?'text-teal-600':'text-gray-300'}><Sun size={24}/></button>
                 <button onClick={()=>setActiveTab('diet')} className={activeTab==='diet'?'text-teal-600':'text-gray-300'}><Leaf size={24}/></button>
                 <button onClick={()=>setActiveTab('chat')} className="w-14 h-14 bg-teal-600 rounded-full flex items-center justify-center text-white"><MessageCircle size={28}/></button>
                 <button onClick={()=>setActiveTab('vault')} className={activeTab==='vault'?'text-teal-600':'text-gray-300'}><FolderOpen size={24}/></button>
                 <button onClick={()=>setActiveTab('settings')} className={activeTab==='settings'?'text-teal-600':'text-gray-300'}><Settings size={24}/></button>
              </nav>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
