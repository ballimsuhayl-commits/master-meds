import React, { useState, useEffect, useRef } from 'react';
import { 
  Mic, Save, Activity, CheckCircle2, Droplets, 
  CalendarDays, Syringe, Plus, X, Sparkles, 
  FileText, Pill, MessageCircle, Ban, ArrowRight,
  TrendingUp, AlertCircle, ShoppingCart, Info,
  ChevronRight, Heart, Utensils, Moon, Sun, RotateCcw,
  Camera, Volume2, Brain, Loader2, UserRound, Phone, UserPlus,
  Stethoscope, Ghost, Coffee, Star, Smile, Megaphone
} from 'lucide-react';
import { 
  Chart as ChartJS, ArcElement, Tooltip, Legend, CategoryScale, 
  LinearScale, PointElement, LineElement, Title, Filler
} from 'chart.js';

// --- REGISTER CHART.JS ---
ChartJS.register(
  ArcElement, Tooltip, Legend, CategoryScale, 
  LinearScale, PointElement, LineElement, Title, Filler
);

// --- GEMINI API CONFIG ---
const apiKey = ""; 
const TEXT_MODEL = "gemini-2.5-flash-preview-09-2025";
const TTS_MODEL = "gemini-2.5-flash-preview-tts";
const IMAGE_MODEL = "imagen-4.0-generate-001";

export default function App() {
  // --- CONSTANTS ---
  const QUADRANTS = ['UL', 'UR', 'LL', 'LR'];
  const VIVID_THEME = {
    yellow: "bg-[#FFEB3B] border-[#FBC02D] text-[#000000]",
    pink: "bg-[#FF80AB] border-[#C51162] text-[#FFFFFF]",
    blue: "bg-[#40C4FF] border-[#01579B] text-[#000000]",
    purple: "bg-[#B388FF] border-[#6200EA] text-[#000000]",
    green: "bg-[#69F0AE] border-[#00C853] text-[#000000]",
    white: "bg-[#FFFFFF] border-[#E0E0E0] text-[#000000]"
  };

  // --- CORE STATE ---
  const [mounted, setMounted] = useState(false);
  const [now, setNow] = useState(new Date());
  const [activeTab, setActiveTab] = useState('home');
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [aiInsight, setAiInsight] = useState("");
  const [mascotUrl, setMascotUrl] = useState(null);
  const [isMascotLoading, setIsMascotLoading] = useState(true);
  
  // Custom Modal/Message State (Replaces alert/confirm)
  const [uiMessage, setUiMessage] = useState({ show: false, title: "", text: "", type: "info", onConfirm: null });

  const [dailyMeds, setDailyMeds] = useState([
    { id: 1, n: "Salazopyrin", d: "2x (500mg)", block: 'am', status: 'pending' },
    { id: 2, n: "Xefo Rapid", d: "1x (8mg)", block: 'am', status: 'pending' },
    { id: 3, n: "Cymbalta", d: "90mg", block: 'am', status: 'pending' },
    { id: 4, n: "Prednisone", d: "15mg", block: 'am', status: 'pending' },
    { id: 5, n: "Salazopyrin", d: "2x (500mg)", block: 'pm', status: 'pending' },
    { id: 6, n: "Lyrica", d: "100mg", block: 'pm', status: 'pending' },
    { id: 7, n: "Aspavor", d: "20mg", block: 'pm', status: 'pending' }
  ]);

  const [inventory, setInventory] = useState([
    { name: "Salazopyrin", count: 42, threshold: 10 },
    { name: "Xefo Rapid", count: 12, threshold: 5 },
    { name: "Cymbalta", count: 28, threshold: 7 },
    { name: "Prednisone", count: 15, threshold: 10 },
    { name: "Lyrica", count: 5, threshold: 14 },
    { name: "Aspavor", count: 20, threshold: 7 }
  ]);

  const [water, setWater] = useState(0.75);
  const [lastInjection, setLastInjection] = useState({ site: 'LL', med: 'Abitrexate', date: new Date().toISOString() });
  const [painLevel, setPainLevel] = useState(4);
  const [diary, setDiary] = useState([]);
  const [diaryInput, setDiaryInput] = useState("");
  const [contacts, setContacts] = useState([{ name: '', phone: '' }]);

  // --- INTELLIGENT NOTIFICATION LOGIC ---
  const hours = now.getHours();
  const isMorning = hours >= 6 && hours < 12;
  const isEvening = hours >= 17 && hours < 22;
  const hasPendingAm = dailyMeds.some(m => m.block === 'am' && m.status === 'pending');
  const hasPendingPm = dailyMeds.some(m => m.block === 'pm' && m.status === 'pending');
  
  const shouldShout = (isMorning && hasPendingAm) || (isEvening && hasPendingPm);

  // --- PERSISTENCE ---
  useEffect(() => {
    setMounted(true);
    const ticker = setInterval(() => setNow(new Date()), 30000);
    const saved = localStorage.getItem('master_meds_v2_stable');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        if (parsed.dailyMeds) setDailyMeds(parsed.dailyMeds);
        if (parsed.inventory) setInventory(parsed.inventory);
        if (parsed.water !== undefined) setWater(parsed.water);
        if (parsed.lastInjection) setLastInjection(parsed.lastInjection);
        if (parsed.painLevel !== undefined) setPainLevel(parsed.painLevel);
        if (parsed.diary) setDiary(parsed.diary);
        if (parsed.contacts) setContacts(parsed.contacts);
      } catch (e) { console.error("Restore failed", e); }
    }
    generateMascot();
    return () => clearInterval(ticker);
  }, []);

  useEffect(() => {
    if (!mounted) return;
    localStorage.setItem('master_meds_v2_stable', JSON.stringify({
      dailyMeds, inventory, water, lastInjection, painLevel, diary, contacts
    }));
  }, [dailyMeds, inventory, water, lastInjection, painLevel, diary, contacts, mounted]);

  // --- GEMINI API HELPERS ---
  const fetchWithRetry = async (url, options, retries = 5, backoff = 1000) => {
    try {
      const response = await fetch(url, options);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return await response.json();
    } catch (error) {
      if (retries > 0) {
        await new Promise(resolve => setTimeout(resolve, backoff));
        return fetchWithRetry(url, options, retries - 1, backoff * 2);
      }
      throw error;
    }
  };

  const generateMascot = async () => {
    setIsMascotLoading(true);
    try {
      const prompt = "A clean, high-resolution chibi girl nurse with dark purple hair, white nurse uniform with purple trim and white nurse cap. Shouting through a bullhorn megaphone. Professional flat vector mascot logo style. Pure white background.";
      const result = await fetchWithRetry(
        `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_MODEL}:predict?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ instances: { prompt: prompt }, parameters: { sampleCount: 1 } })
        }
      );
      const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
      setMascotUrl(imageUrl);
    } catch (e) {
      console.error("Mascot failed", e);
    } finally {
      setIsMascotLoading(false);
    }
  };

  const generateNurseBriefing = async () => {
    setIsAiLoading(true);
    try {
      const stats = `Adherence: ${Math.round((dailyMeds.filter(m => m.status === 'taken').length / dailyMeds.length) * 100)}%, Pain: ${painLevel}/10, Water: ${water.toFixed(1)}L.`;
      const prompt = `You are Virtual Nurse Gemini. Analyze these stats: ${stats}. Provide a warm greeting, summary, 3 tips, and 2 doctor visit questions. Keep it simple and cheerful. Plain text only.`;
      const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
      setAiInsight(String(text || "I'm checking your charts now..."));
      setActiveTab('stats');
    } catch (error) { 
      showMessage("Connection Busy", "Nurse Gemini is currently with another patient. Please try again soon.", "info");
    } finally { setIsAiLoading(false); }
  };

  const handlePillScan = async (base64) => {
    setIsAiLoading(true);
    try {
      const prompt = "Identify medicine and dosage. Return ONLY JSON: { \"name\": \"Medicine Name\", \"dosage\": \"10mg\" }.";
      const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64 } }] }],
          generationConfig: { responseMimeType: "application/json" }
        })
      });
      const data = JSON.parse(result.candidates?.[0]?.content?.parts?.[0]?.text || "{}");
      if (data.name) {
        showMessage("Medicine Detected", `Gemini detected ${data.name} (${data.dosage}). Would you like to add it?`, "confirm", () => {
          setDailyMeds(prev => [...prev, { id: Date.now(), n: data.name, d: data.dosage, block: 'am', status: 'pending' }]);
        });
      }
    } catch (e) { 
      showMessage("Scan Failed", "Gemini couldn't read the label clearly. Please try again with better lighting.", "info");
    } finally { setIsAiLoading(false); }
  };

  const playVoiceBriefing = async () => {
    if (!aiInsight) return;
    setIsAiLoading(true);
    try {
      const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          contents: [{ parts: [{ text: `Nurse Gemini says: ${aiInsight.substring(0, 500)}` }] }],
          generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }
        })
      });
      const audioData = result.candidates[0].content.parts[0].inlineData.data;
      const wavBlob = await createWavBlob(audioData, 24000);
      new Audio(URL.createObjectURL(wavBlob)).play();
    } catch (e) { console.error(e); } finally { setIsAiLoading(false); }
  };

  const createWavBlob = (base64Pcm, sampleRate) => {
    const pcmData = Uint8Array.from(atob(base64Pcm), c => c.charCodeAt(0));
    const wavHeader = new ArrayBuffer(44);
    const view = new DataView(wavHeader);
    view.setUint32(0, 0x52494646, false); 
    view.setUint32(4, 36 + pcmData.length, true);
    view.setUint32(8, 0x57415645, false); 
    view.setUint32(12, 0x666d7420, false); 
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true); 
    view.setUint16(22, 1, true); 
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 2, true);
    view.setUint16(32, 2, true);
    view.setUint16(34, 16, true);
    view.setUint32(36, 0x64617461, false); 
    view.setUint32(40, pcmData.length, true);
    return new Blob([wavHeader, pcmData], { type: 'audio/wav' });
  };

  // --- UI HANDLERS ---
  const showMessage = (title, text, type = "info", onConfirm = null) => {
    setUiMessage({ show: true, title, text, type, onConfirm });
  };

  const handleMedToggle = (id, action) => {
    setDailyMeds(prev => prev.map(m => {
      if (m.id === id) {
        const isTaken = action === 'take';
        if (isTaken && m.status !== 'taken') {
          setInventory(inv => inv.map(i => i.name === m.n ? { ...i, count: Math.max(0, i.count - 1) } : i));
        }
        return { ...m, status: isTaken ? 'taken' : 'skipped' };
      }
      return m;
    }));
  };

  const logInjection = (site) => {
    setLastInjection({ site, med: 'Abitrexate', date: new Date().toISOString() });
    setDiary(prev => [{ id: Date.now(), text: `Injection at ${site}.`, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), type: 'injection' }, ...prev]);
    showMessage("Rotation Logged", `Site ${site} recorded. Good job keeping to the rotation!`, "info");
  };

  const handleWhatsAppOrder = (medName) => {
    const msg = `Hi, I'm running low on ${medName}, please prepare a refill for me. Thanks!`;
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
  };

  const triggerSos = () => {
    const validPhones = contacts.map(c => c.phone.replace(/\s+/g, '')).filter(p => p.length > 5);
    if (validPhones.length === 0) { 
      showMessage("Setup Required", "Please add emergency numbers in the Kin panel before using SOS.", "info");
      return; 
    }
    showMessage("Send SOS?", "This will prepare an emergency text to your next of kin. Continue?", "confirm", () => {
      window.location.href = `sms:${validPhones.join(',')}?body=${encodeURIComponent("SOS: Urgent assistance needed!")}`;
    });
  };

  // --- SUB-COMPONENTS (Scoped to App) ---
  const MascotAgent = ({ size = "w-24 h-24", shout = false }) => (
    <div className={`relative ${size} flex items-center justify-center overflow-visible`}>
      {isMascotLoading ? (
        <div className="w-full h-full bg-gray-50 rounded-full animate-pulse flex items-center justify-center border-2 border-pink-100">
          <Loader2 size={24} className="text-pink-200 animate-spin" />
        </div>
      ) : mascotUrl ? (
        <img 
          src={mascotUrl} 
          alt="Meds Mascot" 
          className={`w-full h-full object-contain rounded-full border-2 border-pink-50 shadow-sm ${shout ? 'animate-shout-lean' : 'animate-float'}`} 
        />
      ) : (
        <div className="w-full h-full bg-white rounded-full flex items-center justify-center border-2 border-pink-50"><Smile size={32} className="text-pink-100" /></div>
      )}
      {shout && !isMascotLoading && (
        <div className="absolute -top-12 -right-32 animate-text-pop z-50 pointer-events-none">
           <div className="bg-white border-4 border-[#FF4081] px-6 py-3 rounded-3xl font-black text-[#FF4081] text-sm shadow-[0_8px_0_#ad1457] whitespace-nowrap uppercase tracking-tighter">
             TAKE UR MEDS!
           </div>
        </div>
      )}
    </div>
  );

  const DashboardCard = ({ children, colorClass, title, icon: Icon, mascot: Mascot, badge, mascotShout }) => (
    <div className={`p-8 rounded-[3rem] border-2 border-black/10 shadow-[10px_10px_0px_rgba(0,0,0,0.05)] ${colorClass} mb-12 overflow-visible`}>
      <div className="flex justify-between items-center mb-8 overflow-visible">
        <div className="flex items-center gap-6 overflow-visible">
          <div className="p-4 rounded-[1.8rem] bg-white shadow-md flex items-center justify-center overflow-visible">
            {Mascot ? <Mascot size="w-16 h-16" shout={mascotShout} /> : <Icon size={44} className="text-black" />}
          </div>
          <div>
            <h3 className="font-black text-2xl uppercase tracking-tight">{title}</h3>
            {badge && <span className="text-[12px] font-black px-4 py-1 bg-black text-white rounded-full mt-2 inline-block animate-pulse-soft">{badge}</span>}
          </div>
        </div>
      </div>
      {children}
    </div>
  );

  const MedRow = ({ med }) => (
    <div className={`flex items-center justify-between p-6 mb-6 rounded-[2.5rem] bg-white border-2 border-black/5 shadow-md transition-all ${med.status !== 'pending' ? 'opacity-30' : ''}`}>
      <div className="flex-1 min-w-0 pr-4">
        <h4 className={`font-black text-2xl leading-tight truncate ${med.status === 'taken' ? 'line-through' : ''}`}>{med.n}</h4>
        <p className="text-sm font-black opacity-60 uppercase">{med.d}</p>
      </div>
      <div className="flex gap-4 shrink-0">
        {med.status === 'pending' ? (
          <>
            <button onClick={() => handleMedToggle(med.id, 'take')} className="w-20 h-20 flex flex-col items-center justify-center bg-green-500 text-white rounded-[2rem] shadow-[0_8px_0_#1b5e20] active:translate-y-2 active:shadow-none">
              <Smile size={36} /><span className="text-[10px] font-black mt-1 uppercase">TAKE</span>
            </button>
            <button onClick={() => handleMedToggle(med.id, 'skip')} className="w-20 h-20 flex flex-col items-center justify-center bg-red-500 text-white rounded-[2rem] shadow-[0_8px_0_#b71c1c] active:translate-y-2 active:shadow-none">
              <RotateCcw size={36} /><span className="text-[10px] font-black mt-1 uppercase">SKIP</span>
            </button>
          </>
        ) : (
          <div className="px-6 py-4 rounded-3xl bg-gray-100 border-2 border-gray-200 text-sm font-black uppercase text-gray-400">
            {med.status}
          </div>
        )}
      </div>
    </div>
  );

  if (!mounted) return null;

  return (
    <div className="min-h-screen bg-[#FFFFFF] text-[#000000] font-sans overflow-x-hidden touch-pan-y pb-48">
      
      {/* 1. HEADER */}
      <header className="pt-20 pb-10 px-10 flex justify-between items-center bg-white border-b-8 border-gray-50">
        <div className="flex items-center gap-8">
          <div className="w-28 h-28 rounded-[2.5rem] bg-white border-4 border-pink-100 p-1 shadow-sm flex items-center justify-center overflow-hidden">
             <img src={mascotUrl || "https://placehold.co/200?text=+"} className="w-full h-full object-contain" alt="Logo Mascot" />
          </div>
          <div>
            <h1 className="text-7xl font-black tracking-tighter text-black leading-[0.75]">
              MASTER<br/><span className="text-[#FF4081]">MEDS</span>
            </h1>
            <p className="text-sm font-black uppercase tracking-[0.25em] text-gray-300 mt-4 italic">Your Daily Companion</p>
          </div>
        </div>
        <button onClick={() => generateNurseBriefing()} className="w-24 h-24 rounded-[3rem] bg-white shadow-[0_12px_0_#f0f0f0] border-2 border-gray-100 flex items-center justify-center active:translate-y-2 active:shadow-none transition-all">
          <Ghost size={56} className="text-[#FF4081]" />
        </button>
      </header>

      {/* CUSTOM NOTIFICATION MODAL (Replaces Alerts) */}
      {uiMessage.show && (
        <div className="fixed inset-0 z-[1000] flex items-center justify-center p-10 bg-black/60 backdrop-blur-sm">
           <div className="bg-white w-full max-w-xl rounded-[4rem] border-8 border-black p-12 shadow-2xl animate-in zoom-in duration-300">
              <h2 className="text-5xl font-black uppercase tracking-tighter mb-6">{uiMessage.title}</h2>
              <p className="text-2xl font-bold text-gray-700 leading-tight mb-12">{uiMessage.text}</p>
              <div className="flex gap-6">
                 {uiMessage.type === "confirm" && (
                   <button 
                    onClick={() => { uiMessage.onConfirm?.(); setUiMessage({ ...uiMessage, show: false }); }}
                    className="flex-1 py-8 bg-black text-white text-xl font-black rounded-3xl"
                   >YES</button>
                 )}
                 <button 
                  onClick={() => setUiMessage({ ...uiMessage, show: false })}
                  className="flex-1 py-8 bg-gray-100 text-black text-xl font-black rounded-3xl"
                 >{uiMessage.type === "confirm" ? "CANCEL" : "OK"}</button>
              </div>
           </div>
        </div>
      )}

      {/* AI LOADER OVERLAY */}
      {isAiLoading && (
        <div className="fixed inset-0 bg-white/95 backdrop-blur-2xl z-[999] flex flex-col items-center justify-center p-10">
           <MascotAgent size="w-56 h-56" shout={true} />
           <p className="font-black text-4xl uppercase tracking-widest text-[#FF4081] animate-pulse text-center mt-12">✨ Nurse is Thinking...</p>
        </div>
      )}

      <main className="px-10 mt-14">
        
        {/* ✨ NURSE CHECK-IN BUTTON */}
        {activeTab === 'home' && (
          <div 
            onClick={generateNurseBriefing}
            className="mb-14 p-10 rounded-[4rem] bg-pink-50 border-4 border-pink-200 shadow-[10px_10px_0px_#fce4ec] flex items-center gap-12 active:scale-[0.98] transition-all group overflow-visible"
          >
             <div className="w-32 h-32 rounded-[2.5rem] bg-white border-4 border-pink-400 flex items-center justify-center shadow-md shrink-0 overflow-visible">
                <MascotAgent size="w-28 h-28" shout={shouldShout} />
             </div>
             <div>
                <h3 className="text-4xl font-black tracking-tight text-pink-600">✨ NURSE CHECK-IN</h3>
                <p className="text-sm font-black text-pink-400 uppercase tracking-widest mt-2 italic">
                    {shouldShout ? "URGENT: MEDS READY" : "Tap for your daily report"}
                </p>
             </div>
          </div>
        )}

        {/* AI NURSE BRIEFING TAB */}
        {activeTab === 'stats' && (
          <DashboardCard colorClass={VIVID_THEME.white} title="✨ Nurse Briefing" mascot={MascotAgent} mascotShout={shouldShout}>
             {!aiInsight ? (
               <div className="text-center py-20">
                 <button onClick={generateNurseBriefing} className="w-full py-10 bg-pink-500 text-white rounded-[3rem] text-2xl font-black shadow-[0_12px_0_#ad1457] active:translate-y-2 active:shadow-none transition-all uppercase tracking-widest">
                   ✨ PREPARE DAILY REPORT
                 </button>
               </div>
             ) : (
               <div className="space-y-12">
                 <div className="p-12 bg-pink-50 rounded-[4rem] border-4 border-pink-100 shadow-inner">
                    <p className="text-2xl font-bold text-gray-800 leading-relaxed whitespace-pre-wrap">{aiInsight || ""}</p>
                 </div>
                 <div className="grid grid-cols-2 gap-8">
                    <button onClick={playVoiceBriefing} className="py-10 bg-blue-500 text-white rounded-[3rem] font-black shadow-[0_12px_0_#01579b] active:translate-y-2 active:shadow-none flex items-center justify-center gap-6">
                      <Volume2 size={48} /> <span className="text-xl">LISTEN</span>
                    </button>
                    <button onClick={() => setAiInsight("")} className="py-10 bg-gray-200 text-gray-500 rounded-[3rem] font-black shadow-[0_12px_0_#9e9e9e] active:translate-y-2 active:shadow-none text-xl">
                      DONE
                    </button>
                 </div>
               </div>
             )}
          </DashboardCard>
        )}

        {/* MEDICATION ROUTINES */}
        {activeTab === 'home' && (
          <>
            <DashboardCard colorClass={VIVID_THEME.yellow} title="Morning Routine" icon={Sun} badge={`${dailyMeds.filter(m => m.block === 'am' && m.status === 'pending').length} REMAINING`}>
              {dailyMeds.filter(m => m.block === 'am').map(med => <MedRow key={med.id} med={med} />)}
              <div className="grid grid-cols-2 gap-8 mt-12">
                <button className="py-10 rounded-[3rem] border-4 border-dashed border-black/10 text-sm font-black text-black/40 uppercase tracking-widest">Manual Entry</button>
                <button onClick={() => {
                  const input = document.createElement('input');
                  input.type = 'file';
                  input.accept = 'image/*';
                  input.onchange = (e) => {
                    const reader = new FileReader();
                    reader.onloadend = () => handlePillScan(reader.result.split(',')[1]);
                    reader.readAsDataURL(e.target.files[0]);
                  };
                  input.click();
                }} className="py-10 rounded-[3rem] bg-black text-white text-sm font-black uppercase flex items-center justify-center gap-4 active:scale-95 shadow-xl tracking-widest">
                  <Camera size={40} /> ✨ SCAN BOTTLE
                </button>
              </div>
            </DashboardCard>

            <DashboardCard colorClass={VIVID_THEME.purple} title="Evening Routine" icon={Moon} badge={`${dailyMeds.filter(m => m.block === 'pm' && m.status === 'pending').length} REMAINING`}>
              {dailyMeds.filter(m => m.block === 'pm').map(med => <MedRow key={med.id} med={med} />)}
            </DashboardCard>

            <DashboardCard colorClass={VIVID_THEME.blue} title="Daily Hydration" icon={Droplets}>
              <div className="flex items-center justify-between mb-12 bg-white/50 p-12 rounded-[4rem] border-4 border-white/30">
                  <div>
                    <p className="text-9xl font-black text-black tracking-tighter leading-none">{water.toFixed(1)}L</p>
                    <p className="text-sm font-black text-black/50 mt-4 uppercase tracking-[0.3em] italic">Goal: 2.5L / Day</p>
                  </div>
                  <div className="h-56 w-20 bg-white rounded-full border-4 border-blue-900 overflow-hidden relative shadow-lg">
                    <div className="absolute bottom-0 left-0 right-0 bg-blue-600 transition-all duration-1000 ease-out" style={{ height: `${(water / 2.5) * 100}%` }}></div>
                  </div>
              </div>
              <div className="grid grid-cols-3 gap-8">
                  <button onClick={() => handleAddWater(0.25)} className="py-10 bg-white border-2 border-black text-2xl font-black rounded-[2.5rem] shadow-[0_12px_0_#000] active:translate-y-2 active:shadow-none">+250ml</button>
                  <button onClick={() => handleAddWater(0.5)} className="py-10 bg-white border-2 border-black text-2xl font-black rounded-[2.5rem] shadow-[0_12px_0_#000] active:translate-y-2 active:shadow-none">+500ml</button>
                  <button onClick={() => setWater(0)} className="py-10 bg-red-100 border-2 border-red-600 text-red-600 text-2xl font-black rounded-[2.5rem] shadow-[0_12px_0_#b71c1c] active:translate-y-2 active:shadow-none">CLR</button>
              </div>
            </DashboardCard>

            {/* INJECTION LOG PANEL */}
            <div className="p-14 rounded-[4.5rem] bg-[#000000] text-white shadow-2xl relative mb-16 border-b-[25px] border-[#FF4081]">
              <div className="flex justify-between items-center mb-14">
                <h3 className="text-xl font-black uppercase tracking-[0.4em] text-[#FF4081] flex items-center gap-8">
                    <Syringe size={48} /> INJECTION LOG
                </h3>
                <span className="text-sm font-black px-8 py-3 bg-white/10 rounded-full border-2 border-white/10 tracking-widest uppercase italic">{lastInjection.site} Area</span>
              </div>
              <div className="grid grid-cols-2 gap-16">
                <div className="grid grid-cols-2 gap-8 bg-[#1A1A1A] p-8 rounded-[3.5rem] border-2 border-white/5 shadow-inner">
                  {QUADRANTS.map(q => (
                    <button 
                      key={q} 
                      onClick={() => logInjection(q)}
                      className={`aspect-square rounded-[2.5rem] flex items-center justify-center text-4xl font-black transition-all active:scale-90 ${lastInjection.site === q ? 'bg-[#FF4081] text-white shadow-[0_0_60px_rgba(255,64,129,0.9)] border-4 border-white' : 'bg-white/5 text-white/10'}`}
                    >
                      {q}
                    </button>
                  ))}
                </div>
                <div className="flex flex-col justify-center gap-12 text-center">
                  <div>
                    <p className="text-xs font-black text-white/30 uppercase tracking-widest mb-4 italic">Next Area Rotation</p>
                    <p className="text-8xl font-black text-[#FF4081] leading-none uppercase">{lastInjection.site}</p>
                  </div>
                  <button onClick={() => showMessage("Confirm Rotation", "Mark rotation confirmed for this site?", "confirm", () => logInjection(lastInjection.site))} className="w-full py-10 bg-white text-black rounded-[3rem] text-xl font-black shadow-[0_15px_0_#e0e0e0] active:translate-y-3 active:shadow-none transition-all uppercase tracking-widest">
                    Confirm
                  </button>
                </div>
              </div>
            </div>

            {/* EMERGENCY CONTACT PANEL */}
            <DashboardCard colorClass={VIVID_THEME.white} title="Next of Kin Registry" icon={UserPlus}>
               <p className="text-sm font-black text-gray-400 mb-10 uppercase tracking-widest italic">Maintain your emergency SMS list here.</p>
               <div className="space-y-8">
                  {contacts.map((contact, idx) => (
                    <div key={idx} className="flex flex-col gap-6 p-8 bg-gray-50 rounded-[3rem] border-2 border-gray-100 shadow-inner">
                       <input 
                         type="text" placeholder="Full Name" value={contact.name}
                         onChange={(e) => { const newC = [...contacts]; newC[idx].name = e.target.value; setContacts(newC); }}
                         className="bg-white p-6 rounded-2xl border-2 border-gray-100 text-2xl font-bold outline-none shadow-sm"
                       />
                       <input 
                         type="tel" placeholder="Mobile Number" value={contact.phone}
                         onChange={(e) => { const newC = [...contacts]; newC[idx].phone = e.target.value; setContacts(newC); }}
                         className="bg-white p-6 rounded-2xl border-2 border-gray-100 text-2xl font-bold outline-none shadow-sm"
                       />
                    </div>
                  ))}
                  <button 
                    onClick={() => setContacts([...contacts, { name: '', phone: '' }])}
                    className="w-full py-6 border-4 border-dashed border-gray-200 rounded-[3rem] text-sm font-black text-gray-300 tracking-[0.2em]"
                  >
                    + REGISTER NEW CONTACT
                  </button>
               </div>
            </DashboardCard>

            <DashboardCard colorClass={VIVID_THEME.green} title="Supply Management" icon={ShoppingCart}>
               <div className="space-y-8">
                  {inventory.filter(i => i.count <= i.threshold).map((item, idx) => (
                    <div key={idx} className="flex items-center justify-between p-10 rounded-[3.5rem] bg-red-50 border-4 border-red-200">
                       <div>
                          <p className="text-3xl font-black text-red-900 leading-tight">{item.name}</p>
                          <p className="text-sm font-black text-red-600 uppercase tracking-widest">Stock Alert: {item.count} left</p>
                       </div>
                       <button onClick={() => handleWhatsAppOrder(item.name)} className="px-12 py-8 bg-red-600 text-white rounded-[2.5rem] text-sm font-black shadow-xl tracking-widest">REFILL</button>
                    </div>
                  ))}
               </div>
            </DashboardCard>
          </>
        )}
      </main>

      {/* 5. NAVIGATION BAR */}
      <nav className="fixed bottom-0 left-0 right-0 bg-white border-t-8 border-gray-50 px-10 py-12 pb-16 flex items-center justify-around z-[800] shadow-[0_-30px_60px_rgba(0,0,0,0.15)]">
        <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-4 ${activeTab === 'home' ? 'text-[#FF4081]' : 'text-gray-300'}`}>
          <Sun size={64} className="animate-pulse-soft" />
          <span className="text-[12px] font-black uppercase tracking-widest">Home</span>
        </button>
        <button onClick={() => setActiveTab('stats')} className={`flex flex-col items-center gap-4 ${activeTab === 'stats' ? 'text-blue-500' : 'text-gray-300'}`}>
          <div className={`w-16 h-16 ${activeTab === 'stats' ? '' : 'grayscale opacity-30'}`}>
            <MascotAgent size="w-full h-full" shout={shouldShout} />
          </div>
          <span className="text-[12px] font-black uppercase tracking-widest">Nurse</span>
        </button>
        <div className="w-2 h-24 bg-gray-100 rounded-full"></div>
        <button onClick={triggerSos} className="flex flex-col items-center gap-4 p-6 bg-red-50 text-red-600 rounded-[3.5rem] active:scale-90 transition-all animate-wiggle-slow">
          <AlertCircle size={64} />
          <span className="text-[12px] font-black uppercase tracking-widest">SOS</span>
        </button>
      </nav>

      <style>{`
        /* --- ANIMATION KEYFRAMES --- */
        @keyframes shout-lean { 0%, 100% { transform: scale(1.0) rotate(0deg); } 50% { transform: scale(1.1) rotate(5deg); } }
        @keyframes text-pop { 0% { transform: scale(0) translate(-20px, 20px); opacity: 0; } 70% { transform: scale(1.2) translate(15px, -15px); opacity: 1; } 100% { transform: scale(1) translate(0, 0); opacity: 1; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
        @keyframes pulse-soft { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.1); opacity: 0.8; } }
        @keyframes wiggle-slow { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }

        .animate-shout-lean { animation: shout-lean 0.6s ease-in-out infinite; }
        .animate-text-pop { animation: text-pop 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) infinite; }
        .animate-float { animation: float 3.5s ease-in-out infinite; }
        .animate-pulse-soft { animation: pulse-soft 2.5s ease-in-out infinite; }
        .animate-wiggle-slow { animation: wiggle-slow 3s ease-in-out infinite; }

        html { -webkit-tap-highlight-color: transparent; font-size: 26px; }
        ::-webkit-scrollbar { display: none; }
        body { user-select: none; -webkit-user-select: none; background: white; }
        input { user-select: text !important; -webkit-user-select: text !important; }
        
        button { transition: transform 0.1s; }
        button:active { transform: scale(0.9) !important; }
      `}</style>

    </div>
  );
}
