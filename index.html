import React, { useState, useEffect, useRef } from 'react';
import { 
  Mic, Save, Activity, CheckCircle2, Droplets, 
  CalendarDays, Syringe, Plus, X, Sparkles, 
  FileText, Pill, MessageCircle, Ban, ArrowRight,
  TrendingUp, AlertCircle, ShoppingCart, Info,
  ChevronRight, Heart, Utensils, Moon, Sun, RotateCcw,
  Camera, Volume2, Brain, Loader2, UserRound, Phone, UserPlus,
  Stethoscope, Ghost, Coffee, Star, Smile, Megaphone
} from 'lucide-react';
import { 
  Chart as ChartJS, ArcElement, Tooltip, Legend, CategoryScale, 
  LinearScale, PointElement, LineElement, Title, Filler
} from 'chart.js';
import { Line } from 'react-chartjs-2';

// --- REGISTER CHART.JS ---
ChartJS.register(
  ArcElement, Tooltip, Legend, CategoryScale, 
  LinearScale, PointElement, LineElement, Title, Filler
);

// --- GEMINI API CONFIG ---
const apiKey = ""; 
const TEXT_MODEL = "gemini-2.5-flash-preview-09-2025";
const TTS_MODEL = "gemini-2.5-flash-preview-tts";
const IMAGE_MODEL = "imagen-4.0-generate-001";

export default function App() {
  // --- CONSTANTS ---
  const QUADRANTS = ['UL', 'UR', 'LL', 'LR'];
  const VIVID_THEME = {
    yellow: "bg-[#FFEB3B] border-[#FBC02D] text-[#000000]",
    pink: "bg-[#FF80AB] border-[#C51162] text-[#FFFFFF]",
    blue: "bg-[#40C4FF] border-[#01579B] text-[#000000]",
    purple: "bg-[#B388FF] border-[#6200EA] text-[#000000]",
    green: "bg-[#69F0AE] border-[#00C853] text-[#000000]",
    white: "bg-[#FFFFFF] border-[#E0E0E0] text-[#000000]"
  };

  // --- CORE STATE ---
  const [mounted, setMounted] = useState(false);
  const [now, setNow] = useState(new Date());
  const [activeTab, setActiveTab] = useState('home');
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [aiInsight, setAiInsight] = useState("");
  const [mascotUrl, setMascotUrl] = useState(null);
  const [isMascotLoading, setIsMascotLoading] = useState(true);
  
  const [dailyMeds, setDailyMeds] = useState([
    { id: 1, n: "Salazopyrin", d: "2x (500mg)", block: 'am', status: 'pending' },
    { id: 2, n: "Xefo Rapid", d: "1x (8mg)", block: 'am', status: 'pending' },
    { id: 3, n: "Cymbalta", d: "90mg", block: 'am', status: 'pending' },
    { id: 4, n: "Prednisone", d: "15mg", block: 'am', status: 'pending' },
    { id: 5, n: "Salazopyrin", d: "2x (500mg)", block: 'pm', status: 'pending' },
    { id: 6, n: "Lyrica", d: "100mg", block: 'pm', status: 'pending' },
    { id: 7, n: "Aspavor", d: "20mg", block: 'pm', status: 'pending' }
  ]);

  const [inventory, setInventory] = useState([
    { name: "Salazopyrin", count: 42, threshold: 10 },
    { name: "Xefo Rapid", count: 12, threshold: 5 },
    { name: "Cymbalta", count: 28, threshold: 7 },
    { name: "Prednisone", count: 15, threshold: 10 },
    { name: "Lyrica", count: 5, threshold: 14 },
    { name: "Aspavor", count: 20, threshold: 7 }
  ]);

  const [water, setWater] = useState(0.75);
  const [lastInjection, setLastInjection] = useState({ site: 'LL', med: 'Abitrexate', date: new Date().toISOString() });
  const [painLevel, setPainLevel] = useState(4);
  const [diary, setDiary] = useState([]);
  const [diaryInput, setDiaryInput] = useState("");
  const [isRecording, setIsRecording] = useState(false);
  const [contacts, setContacts] = useState([{ name: '', phone: '' }]);

  // --- DERIVED STATE: SHOULD SHOUT? ---
  const hours = now.getHours();
  const isMorning = hours >= 6 && hours < 12;
  const isEvening = hours >= 17 && hours < 22;
  
  const hasPendingAm = dailyMeds.some(m => m.block === 'am' && m.status === 'pending');
  const hasPendingPm = dailyMeds.some(m => m.block === 'pm' && m.status === 'pending');
  
  // Mascot shouts if it's the right time AND there are meds to take
  const shouldShout = (isMorning && hasPendingAm) || (isEvening && hasPendingPm);

  // --- PERSISTENCE ---
  useEffect(() => {
    setMounted(true);
    const ticker = setInterval(() => setNow(new Date()), 60000);
    const saved = localStorage.getItem('master_meds_v2_final');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        if (parsed.dailyMeds) setDailyMeds(parsed.dailyMeds);
        if (parsed.inventory) setInventory(parsed.inventory);
        if (parsed.water !== undefined) setWater(parsed.water);
        if (parsed.lastInjection) setLastInjection(parsed.lastInjection);
        if (parsed.painLevel !== undefined) setPainLevel(parsed.painLevel);
        if (parsed.diary) setDiary(parsed.diary);
        if (parsed.contacts) setContacts(parsed.contacts);
      } catch (e) { console.error("Restore failed", e); }
    }
    generateMascot();
    return () => clearInterval(ticker);
  }, []);

  useEffect(() => {
    if (!mounted) return;
    localStorage.setItem('master_meds_v2_final', JSON.stringify({
      dailyMeds, inventory, water, lastInjection, painLevel, diary, contacts
    }));
  }, [dailyMeds, inventory, water, lastInjection, painLevel, diary, contacts, mounted]);

  // --- GEMINI API INTEGRATIONS ---
  const fetchWithRetry = async (url, options, retries = 5, backoff = 1000) => {
    try {
      const response = await fetch(url, options);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return await response.json();
    } catch (error) {
      if (retries > 0) {
        await new Promise(resolve => setTimeout(resolve, backoff));
        return fetchWithRetry(url, options, retries - 1, backoff * 2);
      }
      throw error;
    }
  };

  const generateMascot = async () => {
    setIsMascotLoading(true);
    try {
      const prompt = "A high-resolution mascot logo of a chibi girl nurse with dark purple hair, white nurse uniform, and cap. She is holding a megaphone and shouting. Professional flat vector art, white background.";
      const result = await fetchWithRetry(
        `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_MODEL}:predict?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ instances: { prompt: prompt }, parameters: { sampleCount: 1 } })
        }
      );
      const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
      setMascotUrl(imageUrl);
    } catch (e) {
      console.error("Mascot load failed", e);
    } finally {
      setIsMascotLoading(false);
    }
  };

  const generateNurseBriefing = async () => {
    setIsAiLoading(true);
    try {
      const stats = `Adherence: ${Math.round((dailyMeds.filter(m => m.status === 'taken').length / dailyMeds.length) * 100)}%, Pain: ${painLevel}/10`;
      const prompt = `You are Virtual Nurse Gemini. Based on these stats: ${stats}, provide a warm summary and 3 tips. Keep it cheerful.`;
      const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
      setAiInsight(String(text || "I'm checking your charts now..."));
      setActiveTab('stats');
    } catch (error) { alert("Nurse Gemini is busy."); } finally { setIsAiLoading(false); }
  };

  const handlePillScan = async (base64) => {
    setIsAiLoading(true);
    try {
      const prompt = "Identify medicine. JSON: { \"name\": \"Name\", \"dosage\": \"10mg\" }.";
      const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64 } }] }], generationConfig: { responseMimeType: "application/json" } })
      });
      const data = JSON.parse(result.candidates?.[0]?.content?.parts?.[0]?.text || "{}");
      if (data.name) {
        if (confirm(`✨ detected ${data.name}. Add it?`)) {
          setDailyMeds(prev => [...prev, { id: Date.now(), n: data.name, d: data.dosage, block: 'am', status: 'pending' }]);
        }
      }
    } catch (e) { alert("Error scanning."); } finally { setIsAiLoading(false); }
  };

  const playVoiceBriefing = async () => {
    if (!aiInsight) return;
    setIsAiLoading(true);
    try {
      const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: `Nurse says: ${aiInsight.substring(0, 500)}` }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } } })
      });
      const audioData = result.candidates[0].content.parts[0].inlineData.data;
      const wavBlob = await createWavBlob(audioData, 24000);
      new Audio(URL.createObjectURL(wavBlob)).play();
    } catch (e) { console.error(e); } finally { setIsAiLoading(false); }
  };

  const createWavBlob = (base64Pcm, sampleRate) => {
    const pcmData = Uint8Array.from(atob(base64Pcm), c => c.charCodeAt(0));
    const wavHeader = new ArrayBuffer(44);
    const view = new DataView(wavHeader);
    view.setUint32(0, 0x52494646, false); 
    view.setUint32(4, 36 + pcmData.length, true);
    view.setUint32(8, 0x57415645, false); 
    view.setUint32(12, 0x666d7420, false); 
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true); 
    view.setUint16(22, 1, true); 
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 2, true);
    view.setUint16(32, 2, true);
    view.setUint16(34, 16, true);
    view.setUint32(36, 0x64617461, false); 
    view.setUint32(40, pcmData.length, true);
    return new Blob([wavHeader, pcmData], { type: 'audio/wav' });
  };

  // --- UI HANDLERS ---
  const handleMedToggle = (id, action) => {
    setDailyMeds(prev => prev.map(m => {
      if (m.id === id) {
        const isTaken = action === 'take';
        if (isTaken && m.status !== 'taken') {
          setInventory(inv => inv.map(i => i.name === m.n ? { ...i, count: Math.max(0, i.count - 1) } : i));
        }
        return { ...m, status: isTaken ? 'taken' : 'skipped' };
      }
      return m;
    }));
  };

  const logInjection = (site) => {
    setLastInjection({ site, med: 'Abitrexate', date: new Date().toISOString() });
    setDiary(prev => [{ id: Date.now(), text: `Logged: Injection at ${site}.`, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), type: 'injection' }, ...prev]);
  };

  const handleWhatsAppOrder = (medName) => {
    const msg = `Hi, I'm running low on ${medName}, could you please help with a refill? Thanks!`;
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
  };

  const handleAddWater = (amt) => setWater(prev => Math.min(prev + amt, 3.0));

  const triggerSos = () => {
    const validPhones = contacts.map(c => c.phone.replace(/\s+/g, '')).filter(p => p.length > 5);
    if (validPhones.length === 0) { alert("Set up SOS numbers first."); return; }
    window.location.href = `sms:${validPhones.join(',')}?body=${encodeURIComponent("SOS: Urgent assistance needed!")}`;
  };

  // --- MASCOT COMPONENT ---
  const MascotRemembrancer = ({ className = "w-24 h-24", shout = false }) => (
    <div className={`relative ${className} flex items-center justify-center overflow-visible`}>
      {isMascotLoading ? (
        <div className="w-full h-full bg-gray-100 rounded-full animate-pulse flex items-center justify-center border-2 border-pink-200">
           <Loader2 size={24} className="text-pink-300 animate-spin" />
        </div>
      ) : mascotUrl ? (
        <img 
          src={mascotUrl} 
          alt="Meds Mascot" 
          className={`w-full h-full object-contain rounded-full border-2 border-pink-50 shadow-md ${shout ? 'animate-shout-lean' : 'animate-float'}`} 
        />
      ) : (
        <div className="w-full h-full bg-white rounded-full flex items-center justify-center border-2 border-pink-50">
           <Smile size={32} className="text-pink-100" />
        </div>
      )}
      {shout && !isMascotLoading && (
        <div className="absolute -top-12 -right-28 animate-text-pop z-50">
           <div className="bg-white border-4 border-[#FF4081] px-6 py-3 rounded-3xl font-black text-[#FF4081] text-sm shadow-[0_8px_0_#ad1457] whitespace-nowrap">
             TAKE UR MEDS!
           </div>
        </div>
      )}
    </div>
  );

  // --- SUB-COMPONENTS ---
  const MainPanel = ({ children, colorClass, title, icon: Icon, mascot: Mascot, badge, mascotShout }) => (
    <div className={`p-8 rounded-[3rem] border-2 border-black/10 shadow-[10px_10px_0px_rgba(0,0,0,0.05)] ${colorClass} mb-10 overflow-hidden`}>
      <div className="flex justify-between items-center mb-8">
        <div className="flex items-center gap-5">
          <div className="p-4 rounded-[1.5rem] bg-white shadow-md flex items-center justify-center overflow-visible">
            {Mascot ? <Mascot className="w-16 h-16" shout={mascotShout} /> : <Icon size={40} className="text-black" />}
          </div>
          <div>
            <h3 className="font-black text-2xl uppercase tracking-tight">{title}</h3>
            {badge && <span className="text-[12px] font-black px-4 py-1 bg-black text-white rounded-full mt-2 inline-block animate-pulse-soft">{badge}</span>}
          </div>
        </div>
      </div>
      {children}
    </div>
  );

  const MedRow = ({ med }) => (
    <div className={`flex items-center justify-between p-5 mb-5 rounded-[2.2rem] bg-white border-2 border-black/5 shadow-md transition-all ${med.status !== 'pending' ? 'opacity-30' : ''}`}>
      <div className="flex-1 min-w-0 pr-4">
        <h4 className={`font-black text-2xl leading-tight truncate ${med.status === 'taken' ? 'line-through' : ''}`}>{med.n}</h4>
        <p className="text-sm font-black opacity-60 uppercase">{med.d}</p>
      </div>
      <div className="flex gap-4 shrink-0">
        {med.status === 'pending' ? (
          <>
            <button onClick={() => handleMedToggle(med.id, 'take')} className="w-20 h-20 flex flex-col items-center justify-center bg-green-500 text-white rounded-[1.8rem] shadow-[0_8px_0_#1b5e20] active:translate-y-2 active:shadow-none">
              <Smile size={36} />
              <span className="text-[10px] font-black mt-1 uppercase tracking-tighter">TAKE</span>
            </button>
            <button onClick={() => handleMedToggle(med.id, 'skip')} className="w-20 h-20 flex flex-col items-center justify-center bg-red-500 text-white rounded-[1.8rem] shadow-[0_8px_0_#b71c1c] active:translate-y-2 active:shadow-none">
              <RotateCcw size={36} />
              <span className="text-[10px] font-black mt-1 uppercase tracking-tighter">SKIP</span>
            </button>
          </>
        ) : (
          <div className="px-6 py-4 rounded-2xl bg-gray-100 border-2 border-gray-200 text-sm font-black uppercase text-gray-500">
            {med.status}
          </div>
        )}
      </div>
    </div>
  );

  if (!mounted) return null;

  return (
    <div className="min-h-screen bg-[#FFFFFF] text-[#000000] font-sans overflow-x-hidden touch-pan-y pb-48">
      
      {/* 1. HEADER */}
      <header className="pt-20 pb-10 px-10 flex justify-between items-center bg-white border-b-8 border-gray-50">
        <div className="flex items-center gap-6">
          <div className="w-24 h-24 rounded-[2rem] bg-white border-4 border-pink-100 p-1 shadow-sm overflow-hidden flex items-center justify-center">
            <img src={mascotUrl || "https://placehold.co/100?text=+"} className="w-full h-full object-contain" />
          </div>
          <div>
            <h1 className="text-7xl font-black tracking-tighter text-black leading-[0.75]">
              MASTER<br/><span className="text-[#FF4081]">MEDS</span>
            </h1>
            <p className="text-sm font-black uppercase tracking-[0.25em] text-gray-300 mt-4">
              {now.toLocaleDateString('en-ZA', { weekday: 'long', day: 'numeric', month: 'long' })}
            </p>
          </div>
        </div>
        <button onClick={() => generateMascot()} className="w-24 h-24 rounded-[2.5rem] bg-white shadow-[0_12px_0_#f0f0f0] border-2 border-gray-100 flex items-center justify-center active:translate-y-2 active:shadow-none transition-all">
          <Pill size={48} className="text-[#FF4081]" />
        </button>
      </header>

      {/* AI LOADER */}
      {isAiLoading && (
        <div className="fixed inset-0 bg-white/90 backdrop-blur-xl z-[999] flex flex-col items-center justify-center">
           <MascotRemembrancer className="w-48 h-48 mb-8 scale-125" shout={true} />
           <p className="font-black text-3xl uppercase tracking-widest text-[#FF4081] animate-pulse text-center px-10">✨ checking in...</p>
        </div>
      )}

      <main className="px-10 mt-12">
        
        {/* ✨ NURSE CHECK-IN BUTTON (Intelligent Shout Triggered here too) */}
        {activeTab === 'home' && (
          <div 
            onClick={generateNurseBriefing}
            className="mb-14 p-10 rounded-[3.5rem] bg-pink-50 border-4 border-pink-200 shadow-[10px_10px_0px_#fce4ec] flex items-center gap-10 active:scale-[0.98] transition-all group overflow-visible"
          >
             <div className="w-28 h-28 rounded-[2rem] bg-white border-4 border-pink-400 flex items-center justify-center shadow-md shrink-0 overflow-visible">
                <MascotRemembrancer className="w-24 h-24" shout={shouldShout} />
             </div>
             <div>
                <h3 className="text-3xl font-black tracking-tight text-pink-600">✨ NURSE CHECK-IN</h3>
                <p className="text-sm font-black text-pink-400 uppercase tracking-widest mt-1 italic">
                    {shouldShout ? "URGENT: MEDS READY" : "Tap for daily briefing"}
                </p>
             </div>
          </div>
        )}

        {/* AI NURSE BRIEFING TAB */}
        {activeTab === 'stats' && (
          <MainPanel colorClass={VIVID_THEME.white} title="✨ Nurse Briefing" mascot={MascotRemembrancer} mascotShout={shouldShout}>
             {!aiInsight ? (
               <div className="text-center py-16">
                 <button onClick={generateNurseBriefing} className="w-full py-8 bg-pink-500 text-white rounded-[2.5rem] text-2xl font-black shadow-[0_10px_0_#ad1457] active:translate-y-2 active:shadow-none">
                   ✨ PREPARE REPORT
                 </button>
               </div>
             ) : (
               <div className="space-y-10">
                 <div className="p-10 bg-pink-50 rounded-[3rem] border-4 border-pink-100 shadow-inner">
                    <p className="text-2xl font-bold text-gray-800 leading-relaxed whitespace-pre-wrap">{String(aiInsight)}</p>
                 </div>
                 <div className="grid grid-cols-2 gap-6">
                    <button onClick={playVoiceBriefing} className="py-8 bg-blue-500 text-white rounded-[2.5rem] font-black shadow-[0_10px_0_#01579b] active:translate-y-2 active:shadow-none flex items-center justify-center gap-4">
                      <Volume2 size={40} /> <span className="text-lg">LISTEN</span>
                    </button>
                    <button onClick={() => setAiInsight("")} className="py-8 bg-gray-200 text-gray-500 rounded-[2.5rem] font-black shadow-[0_10px_0_#9e9e9e] active:translate-y-2 active:shadow-none text-lg">
                      DONE
                    </button>
                 </div>
               </div>
             )}
          </MainPanel>
        )}

        {/* MEDICATION ROUTINES */}
        {activeTab === 'home' && (
          <>
            <MainPanel colorClass={VIVID_THEME.yellow} title="Morning Routine" icon={Sun} badge={`${dailyMeds.filter(m => m.block === 'am' && m.status === 'pending').length} TODO`}>
              {dailyMeds.filter(m => m.block === 'am').map(med => <MedRow key={med.id} med={med} />)}
              <div className="grid grid-cols-2 gap-6 mt-10">
                <button className="py-8 rounded-[2.5rem] border-4 border-dashed border-black/10 text-sm font-black text-black/40 uppercase tracking-widest">Manual</button>
                <button onClick={() => {
                  const input = document.createElement('input');
                  input.type = 'file';
                  input.accept = 'image/*';
                  input.onchange = (e) => {
                    const reader = new FileReader();
                    reader.onloadend = () => handlePillScan(reader.result.split(',')[1]);
                    reader.readAsDataURL(e.target.files[0]);
                  };
                  input.click();
                }} className="py-8 rounded-[2.5rem] bg-black text-white text-sm font-black uppercase flex items-center justify-center gap-4 active:scale-95 shadow-lg tracking-widest">
                  <Camera size={32} /> ✨ SCAN
                </button>
              </div>
            </MainPanel>

            <MainPanel colorClass={VIVID_THEME.purple} title="Evening Routine" icon={Moon} badge={`${dailyMeds.filter(m => m.block === 'pm' && m.status === 'pending').length} TODO`}>
              {dailyMeds.filter(m => m.block === 'pm').map(med => <MedRow key={med.id} med={med} />)}
            </MainPanel>

            <MainPanel colorClass={VIVID_THEME.blue} title="Daily Hydration" icon={Droplets}>
              <div className="flex items-center justify-between mb-10 bg-white/50 p-10 rounded-[3rem] border-4 border-white/30">
                  <div>
                    <p className="text-8xl font-black text-black tracking-tighter leading-none">{water.toFixed(1)}L</p>
                    <p className="text-sm font-black text-black/50 mt-4 uppercase tracking-[0.2em]">Goal is 2.5L</p>
                  </div>
                  <div className="h-44 w-16 bg-white rounded-full border-4 border-blue-900 overflow-hidden relative shadow-lg">
                    <div className="absolute bottom-0 left-0 right-0 bg-blue-600 transition-all duration-1000 ease-out" style={{ height: `${(water / 2.5) * 100}%` }}></div>
                  </div>
              </div>
              <div className="grid grid-cols-3 gap-6">
                  <button onClick={() => handleAddWater(0.25)} className="py-8 bg-white border-2 border-black text-lg font-black rounded-[2rem] shadow-[0_10px_0_#000] active:translate-y-2 active:shadow-none">+250</button>
                  <button onClick={() => handleAddWater(0.5)} className="py-8 bg-white border-2 border-black text-lg font-black rounded-[2rem] shadow-[0_10px_0_#000] active:translate-y-2 active:shadow-none">+500</button>
                  <button onClick={() => setWater(0)} className="py-8 bg-red-100 border-2 border-red-600 text-red-600 text-lg font-black rounded-[2rem] shadow-[0_10px_0_#b71c1c] active:translate-y-2 active:shadow-none">CLR</button>
              </div>
            </MainPanel>

            <div className="p-12 rounded-[4rem] bg-[#000000] text-white shadow-2xl relative mb-14 border-b-[20px] border-[#FF4081]">
              <div className="flex justify-between items-center mb-12">
                <h3 className="text-lg font-black uppercase tracking-[0.3em] text-[#FF4081] flex items-center gap-6">
                    <Syringe size={40} /> INJECTION LOG
                </h3>
                <span className="text-sm font-black px-6 py-2 bg-white/10 rounded-full border-2 border-white/10 tracking-widest uppercase">{lastInjection.site}</span>
              </div>
              <div className="grid grid-cols-2 gap-12">
                <div className="grid grid-cols-2 gap-6 bg-[#1A1A1A] p-6 rounded-[3rem] border-2 border-white/5 shadow-inner">
                  {QUADRANTS.map(q => (
                    <button 
                      key={q} 
                      onClick={() => logInjection(q)}
                      className={`aspect-square rounded-[2rem] flex items-center justify-center text-3xl font-black transition-all active:scale-90 ${lastInjection.site === q ? 'bg-[#FF4081] text-white shadow-[0_0_50px_rgba(255,64,129,0.8)] border-4 border-white' : 'bg-white/5 text-white/20'}`}
                    >
                      {q}
                    </button>
                  ))}
                </div>
                <div className="flex flex-col justify-center gap-10">
                  <div className="text-center">
                    <p className="text-xs font-black text-white/30 uppercase tracking-widest mb-4 italic">Next Site</p>
                    <p className="text-7xl font-black text-[#FF4081] leading-none uppercase">{lastInjection.site}</p>
                  </div>
                  <button onClick={() => alert("Injection verified.")} className="w-full py-10 bg-white text-black rounded-[2.5rem] text-lg font-black active:bg-pink-100 shadow-[0_12px_0_#e0e0e0] active:translate-y-2 active:shadow-none transition-all uppercase tracking-widest">
                    Confirm
                  </button>
                </div>
              </div>
            </div>

            <MainPanel colorClass={VIVID_THEME.white} title="Next of Kin & SOS" icon={UserPlus}>
               <div className="space-y-6">
                  {contacts.map((contact, idx) => (
                    <div key={idx} className="flex flex-col gap-4 p-6 bg-gray-50 rounded-[2rem] border-2 border-gray-100">
                       <input 
                         type="text" placeholder="Name" value={contact.name}
                         onChange={(e) => { const newC = [...contacts]; newC[idx].name = e.target.value; setContacts(newC); }}
                         className="bg-white p-4 rounded-xl border-2 border-gray-100 text-lg font-bold outline-none"
                       />
                       <input 
                         type="tel" placeholder="Mobile #" value={contact.phone}
                         onChange={(e) => { const newC = [...contacts]; newC[idx].phone = e.target.value; setContacts(newC); }}
                         className="bg-white p-4 rounded-xl border-2 border-gray-100 text-lg font-bold outline-none"
                       />
                    </div>
                  ))}
                  <button 
                    onClick={() => setContacts([...contacts, { name: '', phone: '' }])}
                    className="w-full py-5 border-4 border-dashed border-gray-200 rounded-[2rem] text-sm font-black text-gray-300 tracking-widest"
                  >
                    + ADD CONTACT
                  </button>
               </div>
            </MainPanel>

            <MainPanel colorClass={VIVID_THEME.green} title="Supply Refills" icon={ShoppingCart}>
               <div className="space-y-6">
                  {inventory.filter(i => i.count <= i.threshold).map((item, idx) => (
                    <div key={idx} className="flex items-center justify-between p-8 rounded-[3rem] bg-red-50 border-4 border-red-200">
                       <div>
                          <p className="text-2xl font-black text-red-900 leading-tight">{item.name}</p>
                          <p className="text-sm font-black text-red-600 uppercase tracking-widest">Low Stock: {item.count} left</p>
                       </div>
                       <button onClick={() => handleWhatsAppOrder(item.name)} className="px-10 py-6 bg-red-600 text-white rounded-[2rem] text-sm font-black shadow-xl tracking-widest">REFILL</button>
                    </div>
                  ))}
               </div>
            </MainPanel>
          </>
        )}
      </main>

      {/* 5. NAVIGATION */}
      <nav className="fixed bottom-0 left-0 right-0 bg-white border-t-8 border-gray-50 px-10 py-10 pb-16 flex items-center justify-around z-[800] shadow-[0_-30px_60px_rgba(0,0,0,0.15)]">
        <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-3 ${activeTab === 'home' ? 'text-[#FF4081]' : 'text-gray-300'}`}>
          <Sun size={56} className="animate-pulse-soft" />
          <span className="text-xs font-black uppercase tracking-widest">Home</span>
        </button>
        <button onClick={() => setActiveTab('stats')} className={`flex flex-col items-center gap-3 ${activeTab === 'stats' ? 'text-blue-500' : 'text-gray-300'}`}>
          <div className={`w-14 h-14 ${activeTab === 'stats' ? '' : 'grayscale opacity-30'}`}>
            <MascotRemembrancer className="w-full h-full" shout={shouldShout} />
          </div>
          <span className="text-xs font-black uppercase tracking-widest">Nurse</span>
        </button>
        <div className="w-2 h-20 bg-gray-100 rounded-full"></div>
        <button onClick={triggerSos} className="flex flex-col items-center gap-3 p-6 bg-red-50 text-red-600 rounded-[3.5rem] active:scale-90 transition-all animate-wiggle-slow">
          <AlertCircle size={56} />
          <span className="text-xs font-black uppercase tracking-widest">SOS</span>
        </button>
      </nav>

      <style>{`
        /* --- MASCOT & UI ANIMATIONS --- */
        @keyframes shout-lean { 0%, 100% { transform: scale(1.0) rotate(0deg); } 50% { transform: scale(1.08) rotate(5deg); } }
        @keyframes text-pop { 0% { transform: scale(0) translate(-20px, 20px); opacity: 0; } 70% { transform: scale(1.2) translate(10px, -10px); opacity: 1; } 100% { transform: scale(1) translate(0, 0); opacity: 1; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse-soft { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.1); opacity: 0.8; } }
        @keyframes wiggle-slow { 0%, 100% { transform: rotate(-2deg); } 50% { transform: rotate(2deg); } }

        .animate-shout-lean { animation: shout-lean 0.8s ease-in-out infinite; }
        .animate-text-pop { animation: text-pop 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) infinite; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-pulse-soft { animation: pulse-soft 2s ease-in-out infinite; }
        .animate-wiggle-slow { animation: wiggle-slow 3s ease-in-out infinite; }

        html { -webkit-tap-highlight-color: transparent; font-size: 24px; }
        ::-webkit-scrollbar { display: none; }
        body { user-select: none; -webkit-user-select: none; background: white; }
        input, textarea { user-select: text !important; -webkit-user-select: text !important; }
        
        button { transition: transform 0.1s; }
        button:active { transform: scale(0.92) !important; }
      `}</style>

    </div>
  );
}